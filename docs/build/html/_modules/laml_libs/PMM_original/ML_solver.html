<!DOCTYPE html>

<html lang="en" data-content_root="../../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>laml_libs.PMM_original.ML_solver &#8212; LAML-Pro 2.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=d1102ebc" />
    <link rel="stylesheet" type="text/css" href="../../../_static/alabaster.css?v=12dfc556" />
    <script src="../../../_static/documentation_options.js?v=60dbed4a"></script>
    <script src="../../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for laml_libs.PMM_original.ML_solver</h1><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">treeswift</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">log</span><span class="p">,</span><span class="n">exp</span><span class="p">,</span><span class="n">sqrt</span><span class="p">,</span> <span class="n">isclose</span>
<span class="kn">from</span> <span class="nn">random</span> <span class="kn">import</span> <span class="n">random</span><span class="p">,</span> <span class="n">seed</span><span class="p">,</span> <span class="n">choice</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">optimize</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">laml_libs</span> <span class="kn">import</span> <span class="n">min_llh</span><span class="p">,</span> <span class="n">eps</span><span class="p">,</span> <span class="n">nni_conv_eps</span><span class="p">,</span> <span class="n">DEFAULT_dmin</span><span class="p">,</span> <span class="n">DEFAULT_dmax</span>
<span class="kn">from</span> <span class="nn">.Virtual_solver</span> <span class="kn">import</span> <span class="n">Virtual_solver</span>
<span class="kn">from</span> <span class="nn">scipy.sparse</span> <span class="kn">import</span> <span class="n">csr_matrix</span>
<span class="kn">from</span> <span class="nn">copy</span> <span class="kn">import</span> <span class="n">deepcopy</span>
<span class="kn">from</span> <span class="nn">laml_libs.Utils.lca_lib</span> <span class="kn">import</span> <span class="n">find_LCAs</span>

<div class="viewcode-block" id="Params">
<a class="viewcode-back" href="../../../laml_libs.PMM_original.ML_solver.html#laml_libs.PMM_original.ML_solver.Params">[docs]</a>
<span class="k">class</span> <span class="nc">Params</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">nu</span><span class="p">,</span><span class="n">phi</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nu</span> <span class="o">=</span> <span class="n">nu</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">phi</span> <span class="o">=</span> <span class="n">phi</span></div>


<div class="viewcode-block" id="ML_solver">
<a class="viewcode-back" href="../../../laml_libs.PMM_original.ML_solver.html#laml_libs.PMM_original.ML_solver.ML_solver">[docs]</a>
<span class="k">class</span> <span class="nc">ML_solver</span><span class="p">(</span><span class="n">Virtual_solver</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">treeList</span><span class="p">,</span><span class="n">data</span><span class="p">,</span><span class="n">prior</span><span class="p">,</span><span class="n">params</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;nu&#39;</span><span class="p">:</span><span class="n">eps</span><span class="p">,</span><span class="s1">&#39;phi&#39;</span><span class="p">:</span><span class="n">eps</span><span class="p">}):</span>
        <span class="n">charMtrx</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;charMtrx&#39;</span><span class="p">]</span>
        <span class="n">Q</span> <span class="o">=</span> <span class="n">prior</span><span class="p">[</span><span class="s1">&#39;Q&#39;</span><span class="p">]</span>
        <span class="n">nu</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;nu&#39;</span><span class="p">]</span>
        <span class="n">phi</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;phi&#39;</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">charMtrx</span> <span class="o">=</span> <span class="n">charMtrx</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">trees</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_edges</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">tree</span> <span class="ow">in</span> <span class="n">treeList</span><span class="p">:</span>
            <span class="n">tree_obj</span> <span class="o">=</span> <span class="n">read_tree_newick</span><span class="p">(</span><span class="n">tree</span><span class="p">)</span>
            <span class="n">tree_obj</span><span class="o">.</span><span class="n">suppress_unifurcations</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">num_edges</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">tree_obj</span><span class="o">.</span><span class="n">traverse_postorder</span><span class="p">()))</span>
            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">tree_obj</span><span class="o">.</span><span class="n">traverse_postorder</span><span class="p">():</span>
                <span class="n">node</span><span class="o">.</span><span class="n">mark_recompute</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trees</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tree_obj</span><span class="p">)</span>
        <span class="c1"># normalize Q</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">Q</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">Q_i</span> <span class="ow">in</span> <span class="n">Q</span><span class="p">:</span>
            <span class="n">s</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">([</span><span class="n">Q_i</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">Q_i</span><span class="p">])</span>
            <span class="n">Q_i_norm</span> <span class="o">=</span> <span class="p">{</span><span class="n">x</span><span class="p">:</span><span class="n">Q_i</span><span class="p">[</span><span class="n">x</span><span class="p">]</span><span class="o">/</span><span class="n">s</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">Q_i</span><span class="p">}</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Q_i_norm</span><span class="p">)</span>        
        <span class="c1"># setup params</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">Params</span><span class="p">(</span><span class="n">nu</span><span class="p">,</span><span class="n">phi</span><span class="p">)</span>        
        <span class="c1"># compute numsites, num_edges, dmin, and dmax </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">numsites</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">charMtrx</span><span class="p">[</span><span class="nb">next</span><span class="p">(</span><span class="nb">iter</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">charMtrx</span><span class="o">.</span><span class="n">keys</span><span class="p">()))])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dmin</span> <span class="o">=</span> <span class="n">DEFAULT_dmin</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dmax</span> <span class="o">=</span> <span class="n">DEFAULT_dmax</span>

<div class="viewcode-block" id="ML_solver.get_compute_cache">
<a class="viewcode-back" href="../../../laml_libs.PMM_original.ML_solver.html#laml_libs.PMM_original.ML_solver.ML_solver.get_compute_cache">[docs]</a>
    <span class="k">def</span> <span class="nf">get_compute_cache</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="c1"># override virtual_solver</span>
        <span class="k">return</span> <span class="p">[{}</span> <span class="k">for</span> <span class="n">tree</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trees</span><span class="p">]</span></div>

    
<div class="viewcode-block" id="ML_solver.get_tree_newick">
<a class="viewcode-back" href="../../../laml_libs.PMM_original.ML_solver.html#laml_libs.PMM_original.ML_solver.ML_solver.get_tree_newick">[docs]</a>
    <span class="k">def</span> <span class="nf">get_tree_newick</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="c1"># override virtual_solver</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">tree</span><span class="o">.</span><span class="n">newick</span><span class="p">()</span> <span class="k">for</span> <span class="n">tree</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trees</span><span class="p">]</span></div>


<div class="viewcode-block" id="ML_solver.get_params">
<a class="viewcode-back" href="../../../laml_libs.PMM_original.ML_solver.html#laml_libs.PMM_original.ML_solver.ML_solver.get_params">[docs]</a>
    <span class="k">def</span> <span class="nf">get_params</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="c1"># override virtual_solver</span>
        <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;phi&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">phi</span><span class="p">,</span><span class="s1">&#39;nu&#39;</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">nu</span><span class="p">}</span></div>


<div class="viewcode-block" id="ML_solver.ultrametric_constr">
<a class="viewcode-back" href="../../../laml_libs.PMM_original.ML_solver.html#laml_libs.PMM_original.ML_solver.ML_solver.ultrametric_constr">[docs]</a>
    <span class="k">def</span> <span class="nf">ultrametric_constr</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">N</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ini_all</span><span class="p">())</span>
        <span class="n">M</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">tree</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trees</span><span class="p">:</span> 
            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">tree</span><span class="o">.</span><span class="n">traverse_postorder</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">is_leaf</span><span class="p">():</span>
                    <span class="n">node</span><span class="o">.</span><span class="n">constraint</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.</span><span class="p">]</span><span class="o">*</span><span class="n">N</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">c1</span><span class="p">,</span><span class="n">c2</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">children</span>
                    <span class="n">m</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">-</span><span class="n">y</span> <span class="k">for</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">c1</span><span class="o">.</span><span class="n">constraint</span><span class="p">,</span><span class="n">c2</span><span class="o">.</span><span class="n">constraint</span><span class="p">)]</span>
                    <span class="n">M</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
                    <span class="n">node</span><span class="o">.</span><span class="n">constraint</span> <span class="o">=</span> <span class="n">c1</span><span class="o">.</span><span class="n">constraint</span>
                <span class="n">node</span><span class="o">.</span><span class="n">constraint</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">idx</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">for</span> <span class="n">tree</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trees</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="n">m</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span><span class="o">-</span><span class="n">y</span> <span class="k">for</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trees</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">constraint</span><span class="p">,</span><span class="n">tree</span><span class="o">.</span><span class="n">root</span><span class="o">.</span><span class="n">constraint</span><span class="p">)]</span>
            <span class="n">M</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">M</span></div>


<div class="viewcode-block" id="ML_solver.score_tree">
<a class="viewcode-back" href="../../../laml_libs.PMM_original.ML_solver.html#laml_libs.PMM_original.ML_solver.ML_solver.score_tree">[docs]</a>
    <span class="k">def</span> <span class="nf">score_tree</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">strategy</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;ultra_constr&#39;</span><span class="p">:</span><span class="kc">False</span><span class="p">,</span><span class="s1">&#39;fixed_params&#39;</span><span class="p">:{},</span><span class="s1">&#39;fixed_brlen&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">,</span><span class="s1">&#39;compute_cache&#39;</span><span class="p">:</span><span class="kc">None</span><span class="p">}):</span>
        <span class="n">ultra_constr</span> <span class="o">=</span> <span class="n">strategy</span><span class="p">[</span><span class="s1">&#39;ultra_constr&#39;</span><span class="p">]</span>
        <span class="n">fixed_phi</span> <span class="o">=</span> <span class="n">strategy</span><span class="p">[</span><span class="s1">&#39;fixed_params&#39;</span><span class="p">][</span><span class="s1">&#39;phi&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;phi&#39;</span> <span class="ow">in</span> <span class="n">strategy</span><span class="p">[</span><span class="s1">&#39;fixed_params&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">fixed_nu</span> <span class="o">=</span> <span class="n">strategy</span><span class="p">[</span><span class="s1">&#39;fixed_params&#39;</span><span class="p">][</span><span class="s1">&#39;nu&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;nu&#39;</span> <span class="ow">in</span> <span class="n">strategy</span><span class="p">[</span><span class="s1">&#39;fixed_params&#39;</span><span class="p">]</span> <span class="k">else</span> <span class="kc">None</span>
        <span class="n">fixed_brlen</span> <span class="o">=</span> <span class="n">strategy</span><span class="p">[</span><span class="s1">&#39;fixed_brlen&#39;</span><span class="p">]</span>
        <span class="n">compute_cache</span> <span class="o">=</span> <span class="n">strategy</span><span class="p">[</span><span class="s1">&#39;compute_cache&#39;</span><span class="p">]</span>
        <span class="n">nllh</span><span class="p">,</span><span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimize</span><span class="p">(</span><span class="n">initials</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">verbose</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span><span class="n">ultra_constr</span><span class="o">=</span><span class="n">ultra_constr</span><span class="p">,</span><span class="n">fixed_phi</span><span class="o">=</span><span class="n">fixed_phi</span><span class="p">,</span>
                                    <span class="n">fixed_nu</span><span class="o">=</span><span class="n">fixed_nu</span><span class="p">,</span><span class="n">fixed_brlen</span><span class="o">=</span><span class="n">fixed_brlen</span><span class="p">,</span><span class="n">compute_cache</span><span class="o">=</span><span class="n">compute_cache</span><span class="p">)</span>
        <span class="n">score</span> <span class="o">=</span> <span class="kc">None</span> <span class="k">if</span> <span class="n">nllh</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="o">-</span><span class="n">nllh</span>
        <span class="c1">#if score is None:</span>
        <span class="c1">#    print(&quot;Fatal error: failed to score tree &quot; + self.get_tree_newick() + &quot;. Optimization status: &quot; + status)</span>
        <span class="k">return</span> <span class="n">score</span><span class="p">,</span><span class="n">status</span></div>


<div class="viewcode-block" id="ML_solver.az_partition">
<a class="viewcode-back" href="../../../laml_libs.PMM_original.ML_solver.html#laml_libs.PMM_original.ML_solver.ML_solver.az_partition">[docs]</a>
    <span class="k">def</span> <span class="nf">az_partition</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="c1"># Purpose: partition the tree into edge-distjoint alpha-clades and z-branches</span>
    <span class="c1"># Note: there is a different partition for each target-site</span>
    <span class="c1"># Output: annotate each node of the tree by node.alpha</span>
        <span class="c1"># z-branches are given tag &#39;z&#39;</span>
        <span class="c1"># each of other branches is given a tag </span>
        <span class="c1"># alpha where alpha is the alpha-tree it belongs to</span>
        <span class="k">for</span> <span class="n">tree</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trees</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">tree</span><span class="o">.</span><span class="n">traverse_postorder</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">is_leaf</span><span class="p">():</span>
                    <span class="n">node</span><span class="o">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">numsites</span>
                    <span class="k">for</span> <span class="n">site</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">numsites</span><span class="p">):</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">charMtrx</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">label</span><span class="p">][</span><span class="n">site</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="n">node</span><span class="o">.</span><span class="n">alpha</span><span class="p">[</span><span class="n">site</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;z&#39;</span>
                        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">charMtrx</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">label</span><span class="p">][</span><span class="n">site</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>   
                            <span class="n">node</span><span class="o">.</span><span class="n">alpha</span><span class="p">[</span><span class="n">site</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;?&#39;</span> 
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">node</span><span class="o">.</span><span class="n">alpha</span><span class="p">[</span><span class="n">site</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">charMtrx</span><span class="p">[</span><span class="n">node</span><span class="o">.</span><span class="n">label</span><span class="p">][</span><span class="n">site</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">C</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">children</span>
                    <span class="n">node</span><span class="o">.</span><span class="n">alpha</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">numsites</span>
                    <span class="k">for</span> <span class="n">site</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">numsites</span><span class="p">):</span>
                        <span class="n">S</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">alpha</span><span class="p">[</span><span class="n">site</span><span class="p">]</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">C</span><span class="p">)</span>
                        <span class="n">R</span> <span class="o">=</span> <span class="n">S</span><span class="o">-</span><span class="nb">set</span><span class="p">([</span><span class="s1">&#39;z&#39;</span><span class="p">,</span><span class="s1">&#39;?&#39;</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                        <span class="k">if</span> <span class="s1">&#39;z&#39;</span> <span class="ow">in</span> <span class="n">S</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">R</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">1</span><span class="p">:</span>
                            <span class="n">node</span><span class="o">.</span><span class="n">alpha</span><span class="p">[</span><span class="n">site</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;z&#39;</span>
                        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">R</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                            <span class="n">node</span><span class="o">.</span><span class="n">alpha</span><span class="p">[</span><span class="n">site</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">R</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>    
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">node</span><span class="o">.</span><span class="n">alpha</span><span class="p">[</span><span class="n">site</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;?&quot;</span></div>

    
<div class="viewcode-block" id="ML_solver.lineage_llh">
<a class="viewcode-back" href="../../../laml_libs.PMM_original.ML_solver.html#laml_libs.PMM_original.ML_solver.ML_solver.lineage_llh">[docs]</a>
    <span class="k">def</span> <span class="nf">lineage_llh</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># assume az_partition has been performed so</span>
        <span class="c1"># each node has the attribute node.alpha</span>
        <span class="n">phi</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">phi</span>
        <span class="n">nu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">nu</span>
        <span class="n">llh</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">numsites</span>
        <span class="k">for</span> <span class="n">tree</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trees</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">tree</span><span class="o">.</span><span class="n">traverse_postorder</span><span class="p">():</span>
                <span class="n">p</span> <span class="o">=</span> <span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">node</span><span class="o">.</span><span class="n">edge_length</span><span class="p">)</span>
                <span class="n">node</span><span class="o">.</span><span class="n">L0</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">numsites</span> <span class="c1"># L0 and L1 are stored in log-scale</span>
                <span class="n">node</span><span class="o">.</span><span class="n">L1</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">numsites</span>
                <span class="k">for</span> <span class="n">site</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">numsites</span><span class="p">):</span>    
                    <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">alpha</span><span class="p">[</span><span class="n">site</span><span class="p">]</span> <span class="o">!=</span> <span class="s1">&#39;z&#39;</span><span class="p">:</span>
                        <span class="n">q</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">Q</span><span class="p">[</span><span class="n">site</span><span class="p">][</span><span class="n">node</span><span class="o">.</span><span class="n">alpha</span><span class="p">[</span><span class="n">site</span><span class="p">]]</span> <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">alpha</span><span class="p">[</span><span class="n">site</span><span class="p">]</span> <span class="o">!=</span> <span class="s2">&quot;?&quot;</span> <span class="k">else</span> <span class="mf">1.0</span>
                        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">is_leaf</span><span class="p">():</span>
                            <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">alpha</span><span class="p">[</span><span class="n">site</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;?&quot;</span><span class="p">:</span>         
                                <span class="n">masked_llh</span> <span class="o">=</span> <span class="n">log</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">phi</span><span class="p">)</span><span class="o">*</span><span class="n">p</span><span class="o">**</span><span class="n">nu</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">phi</span><span class="p">)</span><span class="o">*</span><span class="n">p</span><span class="o">**</span><span class="n">nu</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span> <span class="k">else</span> <span class="n">min_llh</span>
                                <span class="n">node</span><span class="o">.</span><span class="n">L0</span><span class="p">[</span><span class="n">site</span><span class="p">]</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">L1</span><span class="p">[</span><span class="n">site</span><span class="p">]</span> <span class="o">=</span> <span class="n">masked_llh</span>
                            <span class="k">else</span><span class="p">:</span>    
                                <span class="n">node</span><span class="o">.</span><span class="n">L0</span><span class="p">[</span><span class="n">site</span><span class="p">]</span> <span class="o">=</span> <span class="n">nu</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="n">node</span><span class="o">.</span><span class="n">edge_length</span><span class="p">)</span> <span class="o">+</span> <span class="n">log</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">p</span><span class="p">)</span> <span class="o">+</span> <span class="n">log</span><span class="p">(</span><span class="n">q</span><span class="p">)</span> <span class="o">+</span> <span class="n">log</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">phi</span><span class="p">)</span> <span class="k">if</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">p</span><span class="p">)</span><span class="o">*</span><span class="n">q</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">phi</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span> <span class="k">else</span> <span class="n">min_llh</span>
                                <span class="n">node</span><span class="o">.</span><span class="n">L1</span><span class="p">[</span><span class="n">site</span><span class="p">]</span> <span class="o">=</span> <span class="n">nu</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="n">node</span><span class="o">.</span><span class="n">edge_length</span><span class="p">)</span> <span class="o">+</span> <span class="n">log</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">phi</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">C</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">children</span>
                            <span class="n">l0</span> <span class="o">=</span> <span class="n">l1</span> <span class="o">=</span> <span class="mi">0</span>
                            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">C</span><span class="p">:</span>
                                <span class="n">l0</span> <span class="o">+=</span> <span class="n">c</span><span class="o">.</span><span class="n">L0</span><span class="p">[</span><span class="n">site</span><span class="p">]</span>
                                <span class="n">l1</span> <span class="o">+=</span> <span class="n">c</span><span class="o">.</span><span class="n">L1</span><span class="p">[</span><span class="n">site</span><span class="p">]</span>
                            <span class="c1">#L0 = exp(l0+(nu+1)*(-node.edge_length)) + exp(l1 + log(1-p)+log(q) + nu*(-node.edge_length)) + (1-p**nu)*int(node.alpha[site]==&quot;?&quot;)   </span>
                            <span class="n">L0</span> <span class="o">=</span> <span class="n">exp</span><span class="p">(</span><span class="n">l0</span><span class="o">+</span><span class="p">(</span><span class="n">nu</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="n">node</span><span class="o">.</span><span class="n">edge_length</span><span class="p">))</span> <span class="o">+</span> <span class="n">q</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">p</span><span class="p">)</span><span class="o">*</span><span class="n">exp</span><span class="p">(</span><span class="n">l1</span> <span class="o">+</span> <span class="n">nu</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="n">node</span><span class="o">.</span><span class="n">edge_length</span><span class="p">))</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">p</span><span class="o">**</span><span class="n">nu</span><span class="p">)</span><span class="o">*</span><span class="nb">int</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">alpha</span><span class="p">[</span><span class="n">site</span><span class="p">]</span><span class="o">==</span><span class="s2">&quot;?&quot;</span><span class="p">)</span>   
                            <span class="n">L1</span> <span class="o">=</span> <span class="n">exp</span><span class="p">(</span><span class="n">l1</span><span class="o">+</span><span class="n">nu</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="n">node</span><span class="o">.</span><span class="n">edge_length</span><span class="p">))</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">p</span><span class="o">**</span><span class="n">nu</span><span class="p">)</span><span class="o">*</span><span class="nb">int</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">alpha</span><span class="p">[</span><span class="n">site</span><span class="p">]</span><span class="o">==</span><span class="s2">&quot;?&quot;</span><span class="p">)</span>
                            <span class="n">node</span><span class="o">.</span><span class="n">L0</span><span class="p">[</span><span class="n">site</span><span class="p">]</span> <span class="o">=</span> <span class="n">min_llh</span> <span class="k">if</span> <span class="n">L0</span><span class="o">==</span><span class="mi">0</span> <span class="k">else</span> <span class="n">log</span><span class="p">(</span><span class="n">L0</span><span class="p">)</span>
                            <span class="n">node</span><span class="o">.</span><span class="n">L1</span><span class="p">[</span><span class="n">site</span><span class="p">]</span> <span class="o">=</span> <span class="n">min_llh</span> <span class="k">if</span> <span class="n">L1</span><span class="o">==</span><span class="mi">0</span> <span class="k">else</span> <span class="n">log</span><span class="p">(</span><span class="n">L1</span><span class="p">)</span>
                                
                        <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">is_root</span><span class="p">()</span> <span class="ow">or</span> <span class="n">node</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">alpha</span><span class="p">[</span><span class="n">site</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;z&#39;</span><span class="p">:</span>
                            <span class="n">llh</span><span class="p">[</span><span class="n">site</span><span class="p">]</span> <span class="o">+=</span> <span class="n">node</span><span class="o">.</span><span class="n">L0</span><span class="p">[</span><span class="n">site</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">llh</span><span class="p">[</span><span class="n">site</span><span class="p">]</span> <span class="o">+=</span> <span class="p">(</span><span class="o">-</span><span class="n">node</span><span class="o">.</span><span class="n">edge_length</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">+</span><span class="n">nu</span><span class="p">)</span> <span class="o">+</span> <span class="nb">int</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">is_leaf</span><span class="p">())</span><span class="o">*</span><span class="n">log</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">phi</span><span class="p">))</span>
        <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">llh</span><span class="p">)</span>         </div>


<div class="viewcode-block" id="ML_solver.ini_brlens">
<a class="viewcode-back" href="../../../laml_libs.PMM_original.ML_solver.html#laml_libs.PMM_original.ML_solver.ML_solver.ini_brlens">[docs]</a>
    <span class="k">def</span> <span class="nf">ini_brlens</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="p">[</span><span class="n">random</span><span class="p">()</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dmax</span><span class="o">/</span><span class="mi">2</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">dmin</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">dmin</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_edges</span><span class="p">)]</span>        
        <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">tree</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trees</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">tree</span><span class="o">.</span><span class="n">traverse_postorder</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">edge_length</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">x</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">edge_length</span> <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">mark_fixed</span> <span class="k">else</span> <span class="nb">max</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">dmin</span><span class="p">,</span><span class="n">node</span><span class="o">.</span><span class="n">edge_length</span><span class="p">)</span>
                <span class="n">idx</span> <span class="o">+=</span> <span class="mi">1</span> 
        <span class="k">return</span> <span class="n">x</span>    </div>


<div class="viewcode-block" id="ML_solver.ini_nu">
<a class="viewcode-back" href="../../../laml_libs.PMM_original.ML_solver.html#laml_libs.PMM_original.ML_solver.ML_solver.ini_nu">[docs]</a>
    <span class="k">def</span> <span class="nf">ini_nu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fixed_nu</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">random</span><span class="p">()</span><span class="o">*</span><span class="mf">0.99</span> <span class="k">if</span> <span class="n">fixed_nu</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">fixed_nu</span></div>

        
<div class="viewcode-block" id="ML_solver.ini_phi">
<a class="viewcode-back" href="../../../laml_libs.PMM_original.ML_solver.html#laml_libs.PMM_original.ML_solver.ML_solver.ini_phi">[docs]</a>
    <span class="k">def</span> <span class="nf">ini_phi</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fixed_phi</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">random</span><span class="p">()</span><span class="o">*</span><span class="mf">0.99</span> <span class="k">if</span> <span class="n">fixed_phi</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">fixed_phi</span>   </div>


<div class="viewcode-block" id="ML_solver.ini_all">
<a class="viewcode-back" href="../../../laml_libs.PMM_original.ML_solver.html#laml_libs.PMM_original.ML_solver.ML_solver.ini_all">[docs]</a>
    <span class="k">def</span> <span class="nf">ini_all</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fixed_phi</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">fixed_nu</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ini_brlens</span><span class="p">()</span> <span class="o">+</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ini_nu</span><span class="p">(</span><span class="n">fixed_nu</span><span class="o">=</span><span class="n">fixed_nu</span><span class="p">),</span><span class="bp">self</span><span class="o">.</span><span class="n">ini_phi</span><span class="p">(</span><span class="n">fixed_phi</span><span class="o">=</span><span class="n">fixed_phi</span><span class="p">)]</span>
        <span class="k">return</span> <span class="n">x</span></div>


<div class="viewcode-block" id="ML_solver.bound_nu">
<a class="viewcode-back" href="../../../laml_libs.PMM_original.ML_solver.html#laml_libs.PMM_original.ML_solver.ML_solver.bound_nu">[docs]</a>
    <span class="k">def</span> <span class="nf">bound_nu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fixed_nu</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">eps</span><span class="p">,</span><span class="mi">10</span><span class="p">)</span> <span class="k">if</span> <span class="n">fixed_nu</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">(</span><span class="n">fixed_nu</span><span class="o">-</span><span class="n">eps</span><span class="p">,</span><span class="n">fixed_nu</span><span class="o">+</span><span class="n">eps</span><span class="p">)</span></div>

    
<div class="viewcode-block" id="ML_solver.bound_phi">
<a class="viewcode-back" href="../../../laml_libs.PMM_original.ML_solver.html#laml_libs.PMM_original.ML_solver.ML_solver.bound_phi">[docs]</a>
    <span class="k">def</span> <span class="nf">bound_phi</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fixed_phi</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="n">eps</span><span class="p">,</span><span class="mf">0.99</span><span class="p">)</span> <span class="k">if</span> <span class="n">fixed_phi</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="p">(</span><span class="n">fixed_phi</span><span class="o">-</span><span class="n">eps</span><span class="p">,</span><span class="n">fixed_phi</span><span class="o">+</span><span class="n">eps</span><span class="p">)</span></div>


<div class="viewcode-block" id="ML_solver.bound_brlen">
<a class="viewcode-back" href="../../../laml_libs.PMM_original.ML_solver.html#laml_libs.PMM_original.ML_solver.ML_solver.bound_brlen">[docs]</a>
    <span class="k">def</span> <span class="nf">bound_brlen</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>        
        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">dmin</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">num_edges</span><span class="p">,[</span><span class="bp">self</span><span class="o">.</span><span class="n">dmax</span><span class="p">]</span><span class="o">*</span><span class="bp">self</span><span class="o">.</span><span class="n">num_edges</span></div>

        
<div class="viewcode-block" id="ML_solver.get_bound">
<a class="viewcode-back" href="../../../laml_libs.PMM_original.ML_solver.html#laml_libs.PMM_original.ML_solver.ML_solver.get_bound">[docs]</a>
    <span class="k">def</span> <span class="nf">get_bound</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">keep_feasible</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">fixed_phi</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">fixed_nu</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="n">br_lower</span><span class="p">,</span><span class="n">br_upper</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bound_brlen</span><span class="p">()</span>  
        <span class="n">phi_lower</span><span class="p">,</span><span class="n">phi_upper</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bound_phi</span><span class="p">(</span><span class="n">fixed_phi</span><span class="o">=</span><span class="n">fixed_phi</span><span class="p">)</span>
        <span class="n">nu_lower</span><span class="p">,</span><span class="n">nu_upper</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bound_nu</span><span class="p">(</span><span class="n">fixed_nu</span><span class="o">=</span><span class="n">fixed_nu</span><span class="p">)</span>
        <span class="n">bounds</span> <span class="o">=</span> <span class="n">optimize</span><span class="o">.</span><span class="n">Bounds</span><span class="p">(</span><span class="n">br_lower</span><span class="o">+</span><span class="p">[</span><span class="n">nu_lower</span><span class="p">,</span><span class="n">phi_lower</span><span class="p">],</span><span class="n">br_upper</span><span class="o">+</span><span class="p">[</span><span class="n">nu_upper</span><span class="p">,</span><span class="n">phi_upper</span><span class="p">],</span><span class="n">keep_feasible</span><span class="o">=</span><span class="n">keep_feasible</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">bounds</span></div>


<div class="viewcode-block" id="ML_solver.x2brlen">
<a class="viewcode-back" href="../../../laml_libs.PMM_original.ML_solver.html#laml_libs.PMM_original.ML_solver.ML_solver.x2brlen">[docs]</a>
    <span class="k">def</span> <span class="nf">x2brlen</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">x</span><span class="p">):</span>
        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">tree</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trees</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">tree</span><span class="o">.</span><span class="n">traverse_postorder</span><span class="p">():</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">node</span><span class="o">.</span><span class="n">mark_fixed</span><span class="p">:</span>
                    <span class="n">node</span><span class="o">.</span><span class="n">edge_length</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span></div>


<div class="viewcode-block" id="ML_solver.x2nu">
<a class="viewcode-back" href="../../../laml_libs.PMM_original.ML_solver.html#laml_libs.PMM_original.ML_solver.ML_solver.x2nu">[docs]</a>
    <span class="k">def</span> <span class="nf">x2nu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">fixed_nu</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">nu</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">num_edges</span><span class="p">]</span> <span class="k">if</span> <span class="n">fixed_nu</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">fixed_nu</span></div>


<div class="viewcode-block" id="ML_solver.x2phi">
<a class="viewcode-back" href="../../../laml_libs.PMM_original.ML_solver.html#laml_libs.PMM_original.ML_solver.ML_solver.x2phi">[docs]</a>
    <span class="k">def</span> <span class="nf">x2phi</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">fixed_phi</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">phi</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">num_edges</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="n">fixed_phi</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">fixed_phi</span></div>


<div class="viewcode-block" id="ML_solver.x2params">
<a class="viewcode-back" href="../../../laml_libs.PMM_original.ML_solver.html#laml_libs.PMM_original.ML_solver.ML_solver.x2params">[docs]</a>
    <span class="k">def</span> <span class="nf">x2params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">fixed_nu</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">fixed_phi</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x2brlen</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x2nu</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">fixed_nu</span><span class="o">=</span><span class="n">fixed_nu</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">x2phi</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">fixed_phi</span><span class="o">=</span><span class="n">fixed_phi</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">__llh__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">lineage_llh</span><span class="p">()</span>

<div class="viewcode-block" id="ML_solver.negative_llh">
<a class="viewcode-back" href="../../../laml_libs.PMM_original.ML_solver.html#laml_libs.PMM_original.ML_solver.ML_solver.negative_llh">[docs]</a>
    <span class="k">def</span> <span class="nf">negative_llh</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">az_partition</span><span class="p">()</span>
        <span class="k">return</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">__llh__</span><span class="p">()</span></div>


<div class="viewcode-block" id="ML_solver.optimize">
<a class="viewcode-back" href="../../../laml_libs.PMM_original.ML_solver.html#laml_libs.PMM_original.ML_solver.ML_solver.optimize">[docs]</a>
    <span class="k">def</span> <span class="nf">optimize</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">initials</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span><span class="n">fixed_phi</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">fixed_nu</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">fixed_brlen</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">compute_cache</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">max_trials</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span><span class="n">random_seeds</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">ultra_constr</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="c1"># random_seeds can either be a single number or a list of intergers where len(random_seeds) = initials</span>
    <span class="c1"># verbose level: 1 --&gt; show all messages; 0 --&gt; show minimal messages; -1 --&gt; completely silent</span>
    <span class="c1"># fixed_brlen is a list of t dictionaries, where t is the number of trees in self.trees, each maps a tuple (a,b) to a number. Each pair a, b is a tuple of two leaf nodes whose LCA define the node for the branch above it to be fixed.</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">all_failed</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="n">all_trials</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">random_seeds</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">rseeds</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">random</span><span class="p">()</span><span class="o">*</span><span class="mi">10000</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">initials</span><span class="p">)]</span>
        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">random_seeds</span><span class="p">)</span> <span class="o">==</span> <span class="nb">int</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Global random seed: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">random_seeds</span><span class="p">))</span>
            <span class="n">seed</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="n">random_seeds</span><span class="p">)</span>
            <span class="n">rseeds</span> <span class="o">=</span> <span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">random</span><span class="p">()</span><span class="o">*</span><span class="mi">10000</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">initials</span><span class="p">)]</span>
        <span class="k">elif</span> <span class="nb">type</span><span class="p">(</span><span class="n">random_seeds</span><span class="p">)</span> <span class="o">==</span> <span class="nb">list</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">random_seeds</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">initials</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Fatal: the number of random seeds is smaller than the number of initials!&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">random_seeds</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">initials</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: the number of random seeds is larger than the number of initials. Ignoring the last &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">random_seeds</span><span class="p">)</span><span class="o">-</span><span class="n">initials</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; seeds&quot;</span><span class="p">)</span>
            <span class="n">rseeds</span> <span class="o">=</span> <span class="n">random_seeds</span><span class="p">[:</span><span class="n">initials</span><span class="p">]</span>    
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Fatal: incorrect random_seeds type provided&quot;</span><span class="p">)</span>        
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">while</span> <span class="n">all_failed</span> <span class="ow">and</span> <span class="n">all_trials</span> <span class="o">&lt;</span> <span class="n">max_trials</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Optimization start with &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">initials</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; initials&quot;</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">rep</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">initials</span><span class="p">):</span>
                <span class="n">randseed</span> <span class="o">=</span> <span class="n">rseeds</span><span class="p">[</span><span class="n">rep</span><span class="p">]</span> <span class="o">+</span> <span class="n">all_trials</span>
                <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Initial point &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">rep</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;. Random seed: &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">randseed</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">ultra_constr</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Numerical optimization started with ultrametric constraint (default)&quot;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>      
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Numerical optimization started without ultrametric constraint [deprecated]&quot;</span><span class="p">)</span>
                <span class="c1"># read in compute_cache</span>
                <span class="k">if</span> <span class="n">compute_cache</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">t</span><span class="p">,</span><span class="n">tree</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trees</span><span class="p">):</span>
                        <span class="n">cache_nodes</span> <span class="o">=</span> <span class="n">find_LCAs</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span><span class="nb">list</span><span class="p">(</span><span class="n">compute_cache</span><span class="p">[</span><span class="n">t</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
                        <span class="k">for</span> <span class="n">i</span><span class="p">,(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">compute_cache</span><span class="p">[</span><span class="n">t</span><span class="p">]):</span>
                            <span class="n">u</span> <span class="o">=</span> <span class="n">cache_nodes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                            <span class="k">for</span> <span class="n">attr</span> <span class="ow">in</span> <span class="n">compute_cache</span><span class="p">[</span><span class="n">t</span><span class="p">][(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)]:</span>
                                <span class="nb">setattr</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">attr</span><span class="p">,</span> <span class="n">compute_cache</span><span class="p">[</span><span class="n">t</span><span class="p">][(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)][</span><span class="n">attr</span><span class="p">])</span>

                <span class="c1"># read in fixed_brlen and mark the tree nodes</span>
                <span class="k">for</span> <span class="n">t</span><span class="p">,</span><span class="n">tree</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">trees</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">tree</span><span class="o">.</span><span class="n">traverse_postorder</span><span class="p">():</span>
                        <span class="n">node</span><span class="o">.</span><span class="n">mark_fixed</span><span class="o">=</span><span class="kc">False</span>
                    <span class="k">if</span> <span class="n">fixed_brlen</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">fixed_nodes</span> <span class="o">=</span> <span class="n">find_LCAs</span><span class="p">(</span><span class="n">tree</span><span class="p">,</span><span class="nb">list</span><span class="p">(</span><span class="n">fixed_brlen</span><span class="p">[</span><span class="n">t</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>        
                        <span class="k">for</span> <span class="n">i</span><span class="p">,(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">fixed_brlen</span><span class="p">[</span><span class="n">t</span><span class="p">]):</span>
                            <span class="n">u</span> <span class="o">=</span> <span class="n">fixed_nodes</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                            <span class="n">u</span><span class="o">.</span><span class="n">edge_length</span> <span class="o">=</span> <span class="n">fixed_brlen</span><span class="p">[</span><span class="n">t</span><span class="p">][(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">)]</span>
                            <span class="n">u</span><span class="o">.</span><span class="n">mark_fixed</span> <span class="o">=</span> <span class="kc">True</span>
                    <span class="c1"># mark the nodes that will need to be recomputed</span>
                    <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">tree</span><span class="o">.</span><span class="n">traverse_postorder</span><span class="p">():</span>
                        <span class="n">node</span><span class="o">.</span><span class="n">mark_recompute</span> <span class="o">=</span> <span class="n">compute_cache</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">node</span><span class="o">.</span><span class="n">mark_fixed</span>
                        <span class="k">for</span> <span class="n">c_node</span> <span class="ow">in</span> <span class="n">node</span><span class="o">.</span><span class="n">children</span><span class="p">:</span>
                            <span class="n">node</span><span class="o">.</span><span class="n">mark_recompute</span> <span class="o">=</span> <span class="n">node</span><span class="o">.</span><span class="n">mark_recompute</span> <span class="ow">or</span> <span class="n">c_node</span><span class="o">.</span><span class="n">mark_recompute</span>
                <span class="n">nllh</span><span class="p">,</span><span class="n">status</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">optimize_one</span><span class="p">(</span><span class="n">randseed</span><span class="p">,</span><span class="n">fixed_phi</span><span class="o">=</span><span class="n">fixed_phi</span><span class="p">,</span><span class="n">fixed_nu</span><span class="o">=</span><span class="n">fixed_nu</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">,</span><span class="n">ultra_constr</span><span class="o">=</span><span class="n">ultra_constr</span><span class="p">)</span>
                
                <span class="k">if</span> <span class="n">nllh</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">all_failed</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Optimal point found for initial point &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">rep</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>
                        <span class="c1">#self.show_params()</span>
                    <span class="c1"># remove zero-length branches</span>
                    <span class="n">processed_trees</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">for</span> <span class="n">tree</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trees</span><span class="p">:</span>
                        <span class="n">tree_copy</span> <span class="o">=</span> <span class="n">read_tree_newick</span><span class="p">(</span><span class="n">tree</span><span class="o">.</span><span class="n">newick</span><span class="p">())</span>
                        <span class="n">tree_copy</span><span class="o">.</span><span class="n">collapse_short_branches</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dmin</span><span class="o">*</span><span class="mf">0.01</span><span class="p">)</span>
                        <span class="n">processed_trees</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tree_copy</span><span class="o">.</span><span class="n">newick</span><span class="p">())</span>
                    <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">nllh</span><span class="p">,</span><span class="n">rep</span><span class="p">,</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">),</span><span class="n">processed_trees</span><span class="p">,</span><span class="n">status</span><span class="p">))</span>
                <span class="k">elif</span> <span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Fatal: failed to optimize using initial point &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">rep</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span>    
            <span class="n">all_trials</span> <span class="o">+=</span> <span class="n">initials</span>    
        <span class="k">if</span> <span class="n">all_failed</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Fatal: Optimization failed on more than &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">max_trials</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; retries. Aborting ...&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>    
            <span class="n">results</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
            <span class="n">best_nllh</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">best_params</span><span class="p">,</span><span class="n">best_trees</span><span class="p">,</span><span class="n">status</span> <span class="o">=</span> <span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">trees</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">tree</span> <span class="ow">in</span> <span class="n">best_trees</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">trees</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">read_tree_newick</span><span class="p">(</span><span class="n">tree</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">best_params</span>
            <span class="k">if</span> <span class="n">verbose</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Numerical optimization finished successfully&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">results</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">status</span></div>


<div class="viewcode-block" id="ML_solver.optimize_one">
<a class="viewcode-back" href="../../../laml_libs.PMM_original.ML_solver.html#laml_libs.PMM_original.ML_solver.ML_solver.optimize_one">[docs]</a>
    <span class="k">def</span> <span class="nf">optimize_one</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">randseed</span><span class="p">,</span><span class="n">fixed_phi</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">fixed_nu</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span><span class="n">ultra_constr</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="c1"># optimize using a specific initial point identified by the input randseed</span>
        <span class="c1"># verbose level: 1 --&gt; show all messages; 0 --&gt; show minimal messages; -1 --&gt; completely silent</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">filterwarnings</span><span class="p">(</span><span class="s2">&quot;ignore&quot;</span><span class="p">)</span>
        <span class="k">def</span> <span class="nf">nllh</span><span class="p">(</span><span class="n">x</span><span class="p">):</span> 
            <span class="bp">self</span><span class="o">.</span><span class="n">x2params</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">fixed_nu</span><span class="o">=</span><span class="n">fixed_nu</span><span class="p">,</span><span class="n">fixed_phi</span><span class="o">=</span><span class="n">fixed_phi</span><span class="p">)</span>            
            <span class="k">return</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">__llh__</span><span class="p">()</span>
        
        <span class="n">seed</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="n">randseed</span><span class="p">)</span>
        <span class="n">x0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ini_all</span><span class="p">(</span><span class="n">fixed_phi</span><span class="o">=</span><span class="n">fixed_phi</span><span class="p">,</span><span class="n">fixed_nu</span><span class="o">=</span><span class="n">fixed_nu</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">az_partition</span><span class="p">()</span>
        <span class="n">bounds</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_bound</span><span class="p">(</span><span class="n">fixed_phi</span><span class="o">=</span><span class="n">fixed_phi</span><span class="p">,</span><span class="n">fixed_nu</span><span class="o">=</span><span class="n">fixed_nu</span><span class="p">)</span>
        <span class="n">constraints</span> <span class="o">=</span> <span class="p">[]</span>    

        <span class="n">A</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">b</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">tree</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">trees</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">tree</span><span class="o">.</span><span class="n">traverse_postorder</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">node</span><span class="o">.</span><span class="n">mark_fixed</span><span class="p">:</span>
                    <span class="n">a</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">x0</span><span class="p">)</span>
                    <span class="n">a</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
                    <span class="n">A</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
                    <span class="n">b</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="o">.</span><span class="n">edge_length</span><span class="p">)</span>
                <span class="n">idx</span> <span class="o">+=</span> <span class="mi">1</span>   
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">A</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>     
            <span class="n">constraints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">optimize</span><span class="o">.</span><span class="n">LinearConstraint</span><span class="p">(</span><span class="n">csr_matrix</span><span class="p">(</span><span class="n">A</span><span class="p">),</span><span class="n">b</span><span class="p">,</span><span class="n">b</span><span class="p">,</span><span class="n">keep_feasible</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">ultra_constr</span><span class="p">:</span>
            <span class="n">M</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ultrametric_constr</span><span class="p">()</span>
            <span class="n">constraints</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">optimize</span><span class="o">.</span><span class="n">LinearConstraint</span><span class="p">(</span><span class="n">csr_matrix</span><span class="p">(</span><span class="n">M</span><span class="p">),[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">M</span><span class="p">),[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">M</span><span class="p">),</span><span class="n">keep_feasible</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
        <span class="n">disp</span> <span class="o">=</span> <span class="p">(</span><span class="n">verbose</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">optimize</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">nllh</span><span class="p">,</span> <span class="n">x0</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s2">&quot;SLSQP&quot;</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;disp&#39;</span><span class="p">:</span><span class="n">disp</span><span class="p">,</span><span class="s1">&#39;iprint&#39;</span><span class="p">:</span><span class="mi">3</span><span class="p">,</span><span class="s1">&#39;maxiter&#39;</span><span class="p">:</span><span class="mi">1000</span><span class="p">},</span> <span class="n">bounds</span><span class="o">=</span><span class="n">bounds</span><span class="p">,</span><span class="n">constraints</span><span class="o">=</span><span class="n">constraints</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">out</span><span class="o">.</span><span class="n">success</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">x2params</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">x</span><span class="p">,</span><span class="n">fixed_phi</span><span class="o">=</span><span class="n">fixed_phi</span><span class="p">,</span><span class="n">fixed_nu</span><span class="o">=</span><span class="n">fixed_nu</span><span class="p">)</span>
            <span class="n">params</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">out</span><span class="o">.</span><span class="n">fun</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">f</span><span class="p">,</span><span class="n">params</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span><span class="kc">None</span>
        <span class="n">status</span> <span class="o">=</span> <span class="s2">&quot;optimal&quot;</span> <span class="k">if</span> <span class="n">out</span><span class="o">.</span><span class="n">success</span> <span class="k">else</span> <span class="n">out</span><span class="o">.</span><span class="n">message</span>
        <span class="k">return</span> <span class="n">f</span><span class="p">,</span><span class="n">status</span></div>
</div>

</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="Main">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../index.html">LAML-Pro</a></h1>








<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../usage.html">Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../modules.html">laml_libs</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2024, U.M.*, G.C.*, B.R..
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 7.4.7</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 0.7.16</a>
      
    </div>

    

    
  </body>
</html>